<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>考试公告管理系统</title>
  <!-- 引入Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- 引入富文本编辑器 wangEditor（轻量、免费、支持图片/链接） -->
  <script src="https://cdn.jsdelivr.net/npm/wangeditor@4.7.12/dist/wangEditor.min.js"></script>
  
  <!-- Tailwind配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#FF7D00',
            neutral: {
              100: '#F5F7FA',
              200: '#E4E7ED',
              300: '#C0C6CF',
              400: '#909399',
              500: '#606266',
              600: '#303133',
            }
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
          boxShadow: {
            'card': '0 4px 20px rgba(0, 0, 0, 0.08)',
            'card-hover': '0 8px 30px rgba(0, 0, 0, 0.12)',
          }
        },
      }
    }
  </script>
  
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .transition-custom {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .card-hover {
        @apply hover:shadow-card-hover hover:-translate-y-1 transition-custom;
      }
    }
  </style>
  
  <style>
    /* 基础样式 */
    body {
      font-family: 'Inter', system-ui, sans-serif;
      scroll-behavior: smooth;
    }
    
    /* 动画效果 */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.5s ease forwards;
    }
    
    .edit-mode {
      border: 2px dashed #165DFF;
      border-radius: 0.5rem;
    }
    
    /* 滚动条样式 */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c0c6cf;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #909399;
    }
    
    /* 富文本编辑器样式 */
    .w-e-toolbar {
      flex-wrap: wrap !important;
      padding: 8px !important;
      border-radius: 8px 8px 0 0 !important;
    }
    .w-e-text-container {
      border-radius: 0 0 8px 8px !important;
      min-height: 150px !important;
    }
    .w-e-menu:hover {
      background-color: #165DFF10 !important;
    }
  </style>
</head>

<body class="bg-neutral-100 text-neutral-600 min-h-screen flex flex-col">
  <!-- 导航栏 -->
  <header id="navbar" class="bg-white shadow-sm fixed w-full z-50 transition-custom">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-graduation-cap text-primary text-2xl"></i>
        <h1 class="text-xl md:text-2xl font-bold text-neutral-600">
          <span id="site-title" class="editable text-primary">考试公告管理系统</span>
        </h1>
      </div>
      
      <div class="flex items-center space-x-4">
        <button id="search-btn" class="p-2 rounded-full hover:bg-neutral-100 transition-custom" title="搜索公告">
          <i class="fa fa-search text-neutral-500"></i>
        </button>
        
        <div class="relative">
          <button id="theme-toggle" class="p-2 rounded-full hover:bg-neutral-100 transition-custom" title="切换主题">
            <i class="fa fa-moon-o text-neutral-500"></i>
          </button>
        </div>
        
        <button id="edit-mode-toggle" class="hidden md:flex items-center space-x-1 px-3 py-1.5 bg-primary/10 text-primary rounded-full hover:bg-primary/20 transition-custom">
          <i class="fa fa-pencil"></i>
          <span>编辑模式</span>
        </button>
        
        <button id="mobile-menu-btn" class="md:hidden p-2 rounded-full hover:bg-neutral-100 transition-custom">
          <i class="fa fa-bars text-neutral-500"></i>
        </button>
      </div>
    </div>
    
    <!-- 移动端菜单 -->
    <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-neutral-200 animate-fade-in">
      <div class="container mx-auto px-4 py-2 flex flex-col space-y-2">
        <button id="mobile-edit-mode" class="flex items-center space-x-1 px-3 py-2 bg-primary/10 text-primary rounded-lg hover:bg-primary/20 transition-custom">
          <i class="fa fa-pencil"></i>
          <span>编辑模式</span>
        </button>
        <div class="relative mt-2 mb-4">
          <input type="text" id="mobile-search" placeholder="搜索公告..." class="w-full px-4 py-2 pl-10 border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-custom">
          <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400"></i>
        </div>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="flex-grow pt-24 pb-16 container mx-auto px-4">
    <!-- 公告统计卡片 -->
    <section id="stats-section" class="mb-10 grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="bg-white rounded-xl shadow-card p-6 card-hover">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-neutral-400 text-sm mb-1">总公告数</p>
            <h3 id="total-notices" class="text-2xl font-bold text-neutral-600">0</h3>
          </div>
          <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
            <i class="fa fa-bullhorn text-primary text-xl"></i>
          </div>
        </div>
        <div class="mt-4 h-1 bg-neutral-100 rounded-full overflow-hidden">
          <div id="total-progress" class="h-full bg-primary rounded-full" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="bg-white rounded-xl shadow-card p-6 card-hover">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-neutral-400 text-sm mb-1">近期考试</p>
            <h3 id="upcoming-exams" class="text-2xl font-bold text-neutral-600">0</h3>
          </div>
          <div class="w-12 h-12 rounded-full bg-secondary/10 flex items-center justify-center">
            <i class="fa fa-calendar-check-o text-secondary text-xl"></i>
          </div>
        </div>
        <div class="mt-4 h-1 bg-neutral-100 rounded-full overflow-hidden">
          <div id="upcoming-progress" class="h-full bg-secondary rounded-full" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="bg-white rounded-xl shadow-card p-6 card-hover">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-neutral-400 text-sm mb-1">重要公告</p>
            <h3 id="important-notices" class="text-2xl font-bold text-neutral-600">0</h3>
          </div>
          <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
            <i class="fa fa-exclamation-circle text-red-500 text-xl"></i>
          </div>
        </div>
        <div class="mt-4 h-1 bg-neutral-100 rounded-full overflow-hidden">
          <div id="important-progress" class="h-full bg-red-500 rounded-full" style="width: 0%"></div>
        </div>
      </div>
    </section>
    
    <!-- 搜索栏（桌面端） -->
    <div id="desktop-search" class="hidden md:block mb-8 relative">
      <input type="text" id="search-input" placeholder="搜索公告标题、考试类型或日期..." class="w-full px-4 py-3 pl-10 border border-neutral-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-custom">
      <i class="fa fa-search absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400"></i>
      <button id="clear-search" class="absolute right-4 top-1/2 -translate-y-1/2 text-neutral-400 hidden">
        <i class="fa fa-times-circle"></i>
      </button>
    </div>
    
    <!-- 公告筛选和添加按钮 -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
      <div class="flex flex-wrap gap-2">
        <button class="filter-btn active px-4 py-2 bg-primary text-white rounded-lg transition-custom" data-filter="all">
          全部公告
        </button>
        <button class="filter-btn px-4 py-2 bg-white text-neutral-600 rounded-lg shadow-sm hover:shadow transition-custom" data-filter="exam">
          考试安排
        </button>
        <button class="filter-btn px-4 py-2 bg-white text-neutral-600 rounded-lg shadow-sm hover:shadow transition-custom" data-filter="registration">
          报名通知
        </button>
        <button class="filter-btn px-4 py-2 bg-white text-neutral-600 rounded-lg shadow-sm hover:shadow transition-custom" data-filter="result">
          成绩公布
        </button>
        <button class="filter-btn px-4 py-2 bg-white text-neutral-600 rounded-lg shadow-sm hover:shadow transition-custom" data-filter="important">
          重要提醒
        </button>
      </div>
      
      <button id="add-notice-btn" class="flex items-center space-x-2 px-4 py-2 bg-primary text-white rounded-lg shadow-sm hover:bg-primary/90 transition-custom">
        <i class="fa fa-plus"></i>
        <span>添加公告</span>
      </button>
    </div>
    
    <!-- 公告列表 -->
    <section id="notices-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- 公告卡片将通过JavaScript动态生成 -->
      <div id="empty-state" class="col-span-full flex flex-col items-center justify-center py-16 text-center">
        <div class="w-24 h-24 rounded-full bg-neutral-200 flex items-center justify-center mb-6">
          <i class="fa fa-file-text-o text-neutral-400 text-4xl"></i>
        </div>
        <h3 class="text-xl font-semibold text-neutral-600 mb-2">暂无公告</h3>
        <p class="text-neutral-400 mb-6 max-w-md">点击"添加公告"按钮创建你的第一条考试公告</p>
        <button id="empty-add-btn" class="flex items-center space-x-2 px-4 py-2 bg-primary text-white rounded-lg shadow-sm hover:bg-primary/90 transition-custom">
          <i class="fa fa-plus"></i>
          <span>添加第一条公告</span>
        </button>
      </div>
    </section>
  </main>

  <!-- 添加/编辑公告模态框 -->
  <div id="notice-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-2xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto animate-fade-in p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 id="modal-title" class="text-xl font-bold text-neutral-600">添加公告</h2>
        <button id="close-modal" class="text-neutral-400 hover:text-neutral-600 transition-custom">
          <i class="fa fa-times text-xl"></i>
        </button>
      </div>
      
      <form id="notice-form" class="space-y-6">
        <input type="hidden" id="notice-id">
        <input type="hidden" id="notice-content-html"> <!-- 存储富文本HTML -->
        <input type="hidden" id="notice-details-html"> <!-- 存储详细信息富文本HTML -->
        
        <div>
          <label for="notice-title" class="block text-sm font-medium text-neutral-600 mb-1">公告标题 <span class="text-red-500">*</span></label>
          <input type="text" id="notice-title" name="title" required class="w-full px-4 py-2 border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-custom">
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="notice-type" class="block text-sm font-medium text-neutral-600 mb-1">公告类型 <span class="text-red-500">*</span></label>
            <select id="notice-type" name="type" required class="w-full px-4 py-2 border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-custom">
              <option value="exam">考试安排</option>
              <option value="registration">报名通知</option>
              <option value="result">成绩公布</option>
              <option value="important">重要提醒</option>
            </select>
          </div>
          
          <div>
            <label for="notice-date" class="block text-sm font-medium text-neutral-600 mb-1">相关日期 <span class="text-red-500">*</span></label>
            <input type="date" id="notice-date" name="date" required class="w-full px-4 py-2 border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-custom">
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-neutral-600 mb-1">公告内容 <span class="text-red-500">*</span></label>
          <div id="content-editor" class="border border-neutral-200 rounded-lg"></div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-neutral-600 mb-1">详细信息（可选）</label>
          <div id="details-editor" class="border border-neutral-200 rounded-lg"></div>
        </div>
        
        <div class="flex items-center">
          <input type="checkbox" id="notice-pinned" name="pinned" class="w-4 h-4 text-primary rounded border-neutral-300 focus:ring-primary/30">
          <label for="notice-pinned" class="ml-2 text-sm text-neutral-600">置顶公告</label>
        </div>
        
        <div class="flex justify-end space-x-3 pt-4 border-t border-neutral-200">
          <button type="button" id="cancel-modal" class="px-4 py-2 border border-neutral-200 text-neutral-600 rounded-lg hover:bg-neutral-50 transition-custom">取消</button>
          <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-custom">保存公告</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 编辑确认模态框 -->
  <div id="confirm-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-2xl shadow-lg w-full max-w-md animate-fade-in p-6">
      <div class="text-center mb-6">
        <div class="w-16 h-16 rounded-full bg-neutral-100 flex items-center justify-center mx-auto mb-4">
          <i id="confirm-icon" class="fa fa-trash text-neutral-500 text-2xl"></i>
        </div>
        <h3 id="confirm-title" class="text-xl font-bold text-neutral-600 mb-2">确认删除</h3>
        <p id="confirm-message" class="text-neutral-400">你确定要删除这条公告吗？此操作不可撤销。</p>
      </div>
      
      <div class="flex justify-center space-x-3">
        <button id="confirm-cancel" class="px-4 py-2 border border-neutral-200 text-neutral-600 rounded-lg hover:bg-neutral-50 transition-custom">取消</button>
        <button id="confirm-ok" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-custom">确认删除</button>
      </div>
    </div>
  </div>

  <!-- 页脚 -->
  <footer class="bg-white border-t border-neutral-200 py-8">
    <div class="container mx-auto px-4">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="mb-4 md:mb-0">
          <p id="footer-text" class="editable text-neutral-400 text-sm">© 2025 考试公告管理系统 - 保留所有权利</p>
        </div>
        
        <div class="flex items-center space-x-6">
          <a href="#" class="text-neutral-400 hover:text-primary transition-custom" title="帮助中心">
            <i class="fa fa-question-circle"></i>
            <span class="ml-1 text-sm">帮助中心</span>
          </a>
          <a href="#" class="text-neutral-400 hover:text-primary transition-custom" title="联系我们">
            <i class="fa fa-envelope-o"></i>
            <span class="ml-1 text-sm">联系我们</span>
          </a>
          <a href="#" class="text-neutral-400 hover:text-primary transition-custom" title="关于系统">
            <i class="fa fa-info-circle"></i>
            <span class="ml-1 text-sm">关于</span>
          </a>
        </div>
      </div>
    </div>
  </footer>

  <!-- JavaScript -->
  <script>
    // 全局变量
    let notices = JSON.parse(localStorage.getItem('examNotices')) || [];
    let currentEditId = null;
    let isEditMode = false;
    let currentFilter = 'all';
    let searchQuery = '';
    // 富文本编辑器实例
    let contentEditor = null;
    let detailsEditor = null;
    
    // DOM元素
    const noticesContainer = document.getElementById('notices-container');
    const emptyState = document.getElementById('empty-state');
    const noticeModal = document.getElementById('notice-modal');
    const noticeForm = document.getElementById('notice-form');
    const confirmModal = document.getElementById('confirm-modal');
    const addNoticeBtn = document.getElementById('add-notice-btn');
    const emptyAddBtn = document.getElementById('empty-add-btn');
    const closeModalBtn = document.getElementById('close-modal');
    const cancelModalBtn = document.getElementById('cancel-modal');
    const confirmOkBtn = document.getElementById('confirm-ok');
    const confirmCancelBtn = document.getElementById('confirm-cancel');
    const editModeToggle = document.getElementById('edit-mode-toggle');
    const mobileEditMode = document.getElementById('mobile-edit-mode');
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const searchInput = document.getElementById('search-input');
    const mobileSearch = document.getElementById('mobile-search');
    const clearSearchBtn = document.getElementById('clear-search');
    const searchBtn = document.getElementById('search-btn');
    const filterBtns = document.querySelectorAll('.filter-btn');
    const themeToggle = document.getElementById('theme-toggle');
    
    // 统计元素
    const totalNoticesEl = document.getElementById('total-notices');
    const upcomingExamsEl = document.getElementById('upcoming-exams');
    const importantNoticesEl = document.getElementById('important-notices');
    const totalProgressEl = document.getElementById('total-progress');
    const upcomingProgressEl = document.getElementById('upcoming-progress');
    const importantProgressEl = document.getElementById('important-progress');
    
    // 可编辑元素
    const editableElements = document.querySelectorAll('.editable');
    
    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      // 初始化富文本编辑器
      initEditor();
      
      // 设置当前日期为默认日期
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('notice-date').value = today;
      
      // 渲染公告列表
      renderNotices();
      
      // 更新统计数据
      updateStats();
      
      // 事件监听
      setupEventListeners();
    });
    
    // 初始化富文本编辑器
    function initEditor() {
      // 公告内容编辑器
      contentEditor = new wangEditor('#content-editor');
      // 配置编辑器（支持图片上传、链接、表情等）
      contentEditor.config.uploadImgShowBase64 = true; // 图片转Base64（无需服务器）
      contentEditor.config.uploadImgMaxSize = 5 * 1024 * 1024; // 图片最大5MB
      contentEditor.config.menus = [
        'head', 'bold', 'fontSize', 'fontColor', 'backgroundColor',
        'link', 'list', 'justify', 'image', 'undo', 'redo'
      ];
      contentEditor.create();
      
      // 详细信息编辑器
      detailsEditor = new wangEditor('#details-editor');
      detailsEditor.config.uploadImgShowBase64 = true;
      detailsEditor.config.uploadImgMaxSize = 5 * 1024 * 1024;
      detailsEditor.config.menus = [
        'head', 'bold', 'fontSize', 'fontColor', 'backgroundColor',
        'link', 'list', 'justify', 'image', 'undo', 'redo'
      ];
      detailsEditor.create();
    }
    
    // 设置事件监听
    function setupEventListeners() {
      // 添加公告按钮
      addNoticeBtn.addEventListener('click', openAddModal);
      emptyAddBtn.addEventListener('click', openAddModal);
      
      // 关闭模态框
      closeModalBtn.addEventListener('click', closeModal);
      cancelModalBtn.addEventListener('click', closeModal);
      
      // 表单提交
      noticeForm.addEventListener('submit', handleFormSubmit);
      
      // 确认模态框
      confirmCancelBtn.addEventListener('click', closeConfirmModal);
      confirmOkBtn.addEventListener('click', handleConfirmAction);
      
      // 编辑模式切换
      editModeToggle.addEventListener('click', toggleEditMode);
      mobileEditMode.addEventListener('click', toggleEditMode);
      
      // 移动端菜单
      mobileMenuBtn.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
      });
      
      // 搜索功能
      searchInput.addEventListener('input', handleSearch);
      mobileSearch.addEventListener('input', handleSearch);
      clearSearchBtn.addEventListener('click', clearSearch);
      searchBtn.addEventListener('click', () => {
        searchInput.focus();
      });
      
      // 筛选功能
      filterBtns.forEach(btn => {
        btn.addEventListener('click', handleFilter);
      });
      
      // 主题切换
      themeToggle.addEventListener('click', toggleTheme);
      
      // 滚动效果
      window.addEventListener('scroll', handleScroll);
      
      // 可编辑元素双击编辑
      editableElements.forEach(el => {
        el.addEventListener('dblclick', enableInlineEdit);
      });
    }
    
    // 渲染公告列表
    function renderNotices() {
      // 清空容器
      noticesContainer.innerHTML = '';
      
      // 过滤公告
      let filteredNotices = [...notices];
      
      // 应用筛选
      if (currentFilter !== 'all') {
        filteredNotices = filteredNotices.filter(notice => notice.type === currentFilter);
      }
      
      // 应用搜索
      if (searchQuery) {
        const query = searchQuery.toLowerCase();
        filteredNotices = filteredNotices.filter(notice => 
          notice.title.toLowerCase().includes(query) ||
          notice.contentText.toLowerCase().includes(query) || // 搜索纯文本内容
          notice.date.includes(query) ||
          getTypeName(notice.type).toLowerCase().includes(query)
        );
      }
      
      // 排序：置顶的在前，然后按日期倒序
      filteredNotices.sort((a, b) => {
        if (a.pinned && !b.pinned) return -1;
        if (!a.pinned && b.pinned) return 1;
        return new Date(b.date) - new Date(a.date);
      });
      
      // 检查是否有公告
      if (filteredNotices.length === 0) {
        emptyState.classList.remove('hidden');
        return;
      }
      
      // 隐藏空状态
      emptyState.classList.add('hidden');
      
      // 渲染公告卡片
      filteredNotices.forEach((notice, index) => {
        const noticeCard = createNoticeCard(notice);
        noticeCard.style.animationDelay = `${index * 0.1}s`;
        noticesContainer.appendChild(noticeCard);
      });
    }
    
    // 创建公告卡片
    function createNoticeCard(notice) {
      const isUpcoming = new Date(notice.date) >= new Date() && notice.type === 'exam';
      const card = document.createElement('div');
      
      card.className = `bg-white rounded-xl shadow-card p-6 card-hover animate-fade-in ${isEditMode ? 'edit-mode' : ''}`;
      card.dataset.id = notice.id;
      
      // 类型标签样式
      const typeClass = getTypeClass(notice.type);
      const typeName = getTypeName(notice.type);
      
      // 提取纯文本用于列表显示（避免富文本代码混乱）
      const previewContent = notice.contentText.length > 100 
        ? notice.contentText.substring(0, 100) + '...' 
        : notice.contentText;
      
      card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
          <span class="px-2.5 py-1 text-xs font-medium rounded-full ${typeClass}">${typeName}</span>
          ${notice.pinned ? '<span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-700 rounded-full"><i class="fa fa-star-o mr-1"></i>置顶</span>' : ''}
        </div>
        
        <h3 class="text-lg font-bold text-neutral-600 mb-2 line-clamp-2 ${isEditMode ? 'editable' : ''}" data-field="title" data-id="${notice.id}">${notice.title}</h3>
        
        <p class="text-neutral-500 text-sm mb-4 line-clamp-3">${previewContent}</p>
        
        <div class="flex justify-between items-center text-sm text-neutral-400 mb-4">
          <span><i class="fa fa-calendar-o mr-1"></i> ${formatDate(notice.date)}</span>
          ${isUpcoming ? `<span class="text-secondary"><i class="fa fa-clock-o mr-1"></i> 即将到来</span>` : ''}
        </div>
        
        <div class="border-t border-neutral-100 pt-4 mt-2">
          <button class="view-details-btn text-primary text-sm hover:underline flex items-center" data-id="${notice.id}">
            <span>查看详情</span>
            <i class="fa fa-angle-right ml-1"></i>
          </button>
        </div>
        
        ${isEditMode ? `
          <div class="flex justify-end space-x-2 mt-4 pt-4 border-t border-neutral-100">
            <button class="edit-notice-btn px-3 py-1.5 bg-primary/10 text-primary rounded-lg text-sm hover:bg-primary/20 transition-custom" data-id="${notice.id}">
              <i class="fa fa-pencil mr-1"></i> 编辑
            </button>
            <button class="delete-notice-btn px-3 py-1.5 bg-red-100 text-red-500 rounded-lg text-sm hover:bg-red-200 transition-custom" data-id="${notice.id}">
              <i class="fa fa-trash mr-1"></i> 删除
            </button>
          </div>
        ` : ''}
      `;
      
      // 添加事件监听
      card.querySelector('.view-details-btn').addEventListener('click', () => {
        showNoticeDetails(notice);
      });
      
      if (isEditMode) {
        // 编辑按钮
        card.querySelector('.edit-notice-btn').addEventListener('click', () => {
          openEditModal(notice.id);
        });
        
        // 删除按钮
        card.querySelector('.delete-notice-btn').addEventListener('click', () => {
          openConfirmModal('delete', notice.id);
        });
        
        // 可编辑元素
        const editableFields = card.querySelectorAll('.editable[data-field]');
        editableFields.forEach(field => {
          field.addEventListener('dblclick', enableInlineEdit);
        });
      }
      
      return card;
    }
    
    // 获取公告类型样式类
    function getTypeClass(type) {
      switch(type) {
        case 'exam':
          return 'bg-primary/10 text-primary';
        case 'registration':
          return 'bg-green-100 text-green-600';
        case 'result':
          return 'bg-purple-100 text-purple-600';
        case 'important':
          return 'bg-red-100 text-red-600';
        default:
          return 'bg-neutral-100 text-neutral-600';
      }
    }
    
    // 获取公告类型名称
    function getTypeName(type) {
      switch(type) {
        case 'exam':
          return '考试安排';
        case 'registration':
          return '报名通知';
        case 'result':
          return '成绩公布';
        case 'important':
          return '重要提醒';
        default:
          return '公告';
      }
    }
    
    // 格式化日期
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }
    
    // 打开添加公告模态框
    function openAddModal() {
      currentEditId = null;
      document.getElementById('modal-title').textContent = '添加公告';
      noticeForm.reset();
      
      // 清空富文本编辑器
      contentEditor.txt.clear();
      detailsEditor.txt.clear();
      
      // 设置默认日期为今天
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('notice-date').value = today;
      
      noticeModal.classList.remove('hidden');
      document.getElementById('notice-title').focus();
    }
    
    // 打开编辑公告模态框
    function openEditModal(id) {
      const notice = notices.find(n => n.id === id);
      if (!notice) return;
      
      currentEditId = id;
      document.getElementById('modal-title').textContent = '编辑公告';
      
      // 填充表单数据
      document.getElementById('notice-id').value = notice.id;
      document.getElementById('notice-title').value = notice.title;
      document.getElementById('notice-type').value = notice.type;
      document.getElementById('notice-date').value = notice.date;
      document.getElementById('notice-pinned').checked = notice.pinned || false;
      
      // 填充富文本编辑器
      contentEditor.txt.html(notice.contentHtml);
      detailsEditor.txt.html(notice.detailsHtml || '');
      
      noticeModal.classList.remove('hidden');
      document.getElementById('notice-title').focus();
    }
    
    // 关闭模态框
    function closeModal() {
      noticeModal.classList.add('hidden');
      currentEditId = null;
    }
    
    // 处理表单提交
    function handleFormSubmit(e) {
      e.preventDefault();
      
      // 获取富文本内容（HTML）和纯文本（用于搜索）
      const contentHtml = contentEditor.txt.html();
      const contentText = contentEditor.txt.text();
      const detailsHtml = detailsEditor.txt.html();
      const detailsText = detailsEditor.txt.text();
      
      const formData = {
        title: document.getElementById('notice-title').value.trim(),
        type: document.getElementById('notice-type').value,
        date: document.getElementById('notice-date').value,
        contentHtml: contentHtml, // 富文本HTML
        contentText: contentText, // 纯文本（用于搜索/预览）
        detailsHtml: detailsHtml, // 详细信息富文本HTML
        detailsText: detailsText, // 详细信息纯文本
        pinned: document.getElementById('notice-pinned').checked,
        id: currentEditId || generateId()
      };
      
      if (currentEditId) {
        // 编辑现有公告
        const index = notices.findIndex(n => n.id === currentEditId);
        if (index !== -1) {
          notices[index] = formData;
        }
      } else {
        // 添加新公告
        notices.unshift(formData);
      }
      
      // 保存到本地存储
      saveNotices();
      
      // 重新渲染
      renderNotices();
      updateStats();
      
      // 关闭模态框
      closeModal();
      
      // 显示成功提示
      showToast(currentEditId ? '公告更新成功' : '公告添加成功');
    }
    
    // 生成唯一ID
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }
    
    // 保存公告到本地存储
    function saveNotices() {
      localStorage.setItem('examNotices', JSON.stringify(notices));
    }
    
    // 打开确认模态框
    function openConfirmModal(action, id) {
      currentEditId = id;
      
      const confirmTitle = document.getElementById('confirm-title');
      const confirmMessage = document.getElementById('confirm-message');
      const confirmIcon = document.getElementById('confirm-icon');
      const confirmOkBtn = document.getElementById('confirm-ok');
      
      switch(action) {
        case 'delete':
          confirmTitle.textContent = '确认删除';
          confirmMessage.textContent = '你确定要删除这条公告吗？此操作不可撤销。';
          confirmIcon.className = 'fa fa-trash text-red-500 text-2xl';
          confirmOkBtn.textContent = '确认删除';
          confirmOkBtn.className = 'px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-custom';
          break;
        case 'clear':
          confirmTitle.textContent = '确认清空';
          confirmMessage.textContent = '你确定要清空所有公告吗？此操作不可撤销。';
          confirmIcon.className = 'fa fa-trash-o text-red-500 text-2xl';
          confirmOkBtn.textContent = '确认清空';
          confirmOkBtn.className = 'px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-custom';
          break;
      }
      
      confirmModal.classList.remove('hidden');
    }
    
    // 关闭确认模态框
    function closeConfirmModal() {
      confirmModal.classList.add('hidden');
      currentEditId = null;
    }
    
    // 处理确认操作
    function handleConfirmAction() {
      if (!currentEditId) return;
      
      if (confirmModal.querySelector('#confirm-title').textContent === '确认删除') {
        // 删除单个公告
        notices = notices.filter(notice => notice.id !== currentEditId);
        saveNotices();
        renderNotices();
        updateStats();
        showToast('公告已删除');
      } else if (confirmModal.querySelector('#confirm-title').textContent === '确认清空') {
        // 清空所有公告
        notices = [];
        saveNotices();
        renderNotices();
        updateStats();
        showToast('所有公告已清空');
      }
      
      closeConfirmModal();
    }
    
    // 切换编辑模式
    function toggleEditMode() {
      isEditMode = !isEditMode;
      
      const editButtons = document.querySelectorAll('.edit-notice-btn, .delete-notice-btn');
      const editableElements = document.querySelectorAll('.editable');
      
      if (isEditMode) {
        // 启用编辑模式
        editModeToggle.innerHTML = '<i class="fa fa-check"></i><span>退出编辑</span>';
        mobileEditMode.innerHTML = '<i class="fa fa-check"></i><span>退出编辑</span>';
        editModeToggle.classList.remove('bg-primary/10', 'text-primary');
        editModeToggle.classList.add('bg-green-100', 'text-green-600');
        mobileEditMode.classList.remove('bg-primary/10', 'text-primary');
        mobileEditMode.classList.add('bg-green-100', 'text-green-600');
        
        // 添加编辑边框
        document.querySelectorAll('#notices-container > div').forEach(card => {
          card.classList.add('edit-mode');
        });
        
        // 显示编辑按钮
        editButtons.forEach(btn => {
          btn.classList.remove('hidden');
        });
        
        // 标记可编辑元素
        editableElements.forEach(el => {
          el.classList.add('cursor-text');
          el.style.padding = '2px 4px';
        });
        
        showToast('已进入编辑模式');
      } else {
        // 禁用编辑模式
        editModeToggle.innerHTML = '<i class="fa fa-pencil"></i><span>编辑模式</span>';
        mobileEditMode.innerHTML = '<i class="fa fa-pencil"></i><span>编辑模式</span>';
        editModeToggle.classList.remove('bg-green-100', 'text-green-600');
        editModeToggle.classList.add('bg-primary/10', 'text-primary');
        mobileEditMode.classList.remove('bg-green-100', 'text-green-600');
        mobileEditMode.classList.add('bg-primary/10', 'text-primary');
        
        // 移除编辑边框
        document.querySelectorAll('#notices-container > div').forEach(card => {
          card.classList.remove('edit-mode');
        });
        
        // 隐藏编辑按钮
        editButtons.forEach(btn => {
          btn.classList.add('hidden');
        });
        
        // 移除可编辑标记
        editableElements.forEach(el => {
          el.classList.remove('cursor-text');
          el.style.padding = '0';
        });
        
        showToast('已退出编辑模式');
      }
      
      // 重新渲染公告
      renderNotices();
    }
    
    // 启用行内编辑
    function enableInlineEdit(e) {
      if (!isEditMode) return;
      
      const el = e.target;
      const field = el.dataset.field;
      const id = el.dataset.id;
      
      // 如果是标题字段
      if (field === 'title') {
        const originalValue = el.textContent.trim();
        
        // 创建输入框
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'w-full px-3 py-1 border border-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30';
        input.value = originalValue;
        
        // 替换元素
        el.parentNode.replaceChild(input, el);
        
        // 自动聚焦并选中
        input.focus();
        input.select();
        
        // 处理失去焦点或回车
        const finishEdit = () => {
          const newValue = input.value.trim();
          
          // 如果值改变了，更新数据
          if (newValue !== originalValue && newValue) {
            const index = notices.findIndex(n => n.id === id);
            if (index !== -1) {
              notices[index].title = newValue;
              saveNotices();
              updateStats();
              showToast('标题已更新');
            }
          }
          
          // 重新渲染
          renderNotices();
        };
        
        input.addEventListener('blur', finishEdit);
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            finishEdit();
          }
        });
      }
    }
    
    // 处理搜索
    function handleSearch(e) {
      searchQuery = e.target.value.trim().toLowerCase();
      
      // 显示/隐藏清除按钮
      if (searchQuery) {
        clearSearchBtn.classList.remove('hidden');
      } else {
        clearSearchBtn.classList.add('hidden');
      }
      
      // 同步两个搜索框
      searchInput.value = searchQuery;
      mobileSearch.value = searchQuery;
      
      // 重新渲染
      renderNotices();
    }
    
    // 清除搜索
    function clearSearch() {
      searchQuery = '';
      searchInput.value = '';
      mobileSearch.value = '';
      clearSearchBtn.classList.add('hidden');
      renderNotices();
    }
    
    // 处理筛选
    function handleFilter(e) {
      const btn = e.target.closest('.filter-btn');
      if (!btn) return;
      
      // 更新当前筛选
      currentFilter = btn.dataset.filter;
      
      // 更新按钮样式
      filterBtns.forEach(b => {
        b.classList.remove('active', 'bg-primary', 'text-white');
        b.classList.add('bg-white', 'text-neutral-600', 'shadow-sm');
      });
      
      btn.classList.add('active', 'bg-primary', 'text-white');
      btn.classList.remove('bg-white', 'text-neutral-600', 'shadow-sm');
      
      // 重新渲染
      renderNotices();
    }
    
    // 显示公告详情
    function showNoticeDetails(notice) {
      // 创建详情模态框
      const detailModal = document.createElement('div');
      detailModal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center animate-fade-in';
      
      detailModal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-neutral-600">${notice.title}</h2>
            <button class="close-detail-btn text-neutral-400 hover:text-neutral-600 transition-custom">
              <i class="fa fa-times text-xl"></i>
            </button>
          </div>
          
          <div class="mb-4 flex items-center space-x-3">
            <span class="px-2.5 py-1 text-xs font-medium rounded-full ${getTypeClass(notice.type)}">${getTypeName(notice.type)}</span>
            <span class="text-sm text-neutral-400"><i class="fa fa-calendar-o mr-1"></i> ${formatDate(notice.date)}</span>
            ${notice.pinned ? '<span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-700 rounded-full"><i class="fa fa-star-o mr-1"></i>置顶</span>' : ''}
          </div>
          
          <div class="mb-6 text-neutral-600 leading-relaxed">
            ${notice.contentHtml}
          </div>
          
          ${notice.detailsHtml ? `
            <div class="border-t border-neutral-200 pt-6">
              <h3 class="text-lg font-semibold text-neutral-600 mb-3">详细信息</h3>
              <div class="text-neutral-500">${notice.detailsHtml}</div>
            </div>
          ` : ''}
          
          ${isEditMode ? `
            <div class="flex justify-end space-x-3 pt-6 border-t border-neutral-200">
              <button class="edit-detail-btn px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-custom" data-id="${notice.id}">
                <i class="fa fa-pencil mr-1"></i> 编辑公告
              </button>
            </div>
          ` : ''}
        </div>
      `;
      
      // 添加到文档
      document.body.appendChild(detailModal);
      
      // 阻止背景滚动
      document.body.style.overflow = 'hidden';
      
      // 事件监听
      detailModal.querySelector('.close-detail-btn').addEventListener('click', () => {
        document.body.removeChild(detailModal);
        document.body.style.overflow = '';
      });
      
      // 编辑按钮
      if (isEditMode) {
        detailModal.querySelector('.edit-detail-btn').addEventListener('click', () => {
          document.body.removeChild(detailModal);
          document.body.style.overflow = '';
          openEditModal(notice.id);
        });
      }
      
      // 点击背景关闭
      detailModal.addEventListener('click', (e) => {
        if (e.target === detailModal) {
          document.body.removeChild(detailModal);
          document.body.style.overflow = '';
        }
      });
    }
    
    // 更新统计数据
    function updateStats() {
      const total = notices.length;
      const upcoming = notices.filter(n => new Date(n.date) >= new Date() && n.type === 'exam').length;
      const important = notices.filter(n => n.type === 'important' || n.pinned).length;
      
      // 更新数值
      totalNoticesEl.textContent = total;
      upcomingExamsEl.textContent = upcoming;
      importantNoticesEl.textContent = important;
      
      // 更新进度条
      const totalProgress = total > 0 ? Math.min(100, (total / 20) * 100) : 0;
      const upcomingProgress = total > 0 ? Math.min(100, (upcoming / total) * 100) : 0;
      const importantProgress = total > 0 ? Math.min(100, (important / total) * 100) : 0;
      
      totalProgressEl.style.width = `${totalProgress}%`;
      upcomingProgressEl.style.width = `${upcomingProgress}%`;
      importantProgressEl.style.width = `${importantProgress}%`;
    }
    
    // 切换主题
    function toggleTheme() {
      const isDarkMode = document.documentElement.classList.toggle('dark');
      const icon = themeToggle.querySelector('i');
      
      if (isDarkMode) {
        icon.classList.remove('fa-moon-o');
        icon.classList.add('fa-sun-o');
        document.body.classList.add('dark');
        localStorage.setItem('darkMode', 'true');
      } else {
        icon.classList.remove('fa-sun-o');
        icon.classList.add('fa-moon-o');
        document.body.classList.remove('dark');
        localStorage.setItem('darkMode', 'false');
      }
    }
    
    // 处理滚动效果
    function handleScroll() {
      const navbar = document.getElementById('navbar');
      if (window.scrollY > 20) {
        navbar.classList.add('py-2', 'shadow');
        navbar.classList.remove('py-3', 'shadow-sm');
      } else {
        navbar.classList.add('py-3', 'shadow-sm');
        navbar.classList.remove('py-2', 'shadow');
      }
    }
    
    // 显示提示消息
    function showToast(message) {
      // 创建toast元素
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-4 right-4 bg-neutral-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in flex items-center';
      
      toast.innerHTML = `
        <i class="fa fa-check-circle mr-2 text-green-400"></i>
        <span>${message}</span>
      `;
      
      // 添加到文档
      document.body.appendChild(toast);
      
      // 3秒后移除
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(10px)';
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }
    
    // 初始化主题
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark');
      themeToggle.querySelector('i').classList.remove('fa-moon-o');
      themeToggle.querySelector('i').classList.add('fa-sun-o');
    }
  </script>
</body>
</html>
